#include "ntt.h"
#include "poly.h"

// Primitive 2N-th root of unity modulo Q
#define ROOT 3 // Example ω such that ω^N ≡ -1 mod Q

// Precomputed powers of ω and its inverse mod Q
const int16_t omega[N] = {
    1, 1, 12288, 12288, 1479, 1479, 10810, 10810,
    4043, 4043, 8246, 8246, 7143, 7143, 5146, 5146,
    5736, 5736, 6553, 6553, 4134, 4134, 8155, 8155,
    1305, 1305, 10984, 10984, 722, 722, 11567, 11567,
    10643, 10643, 1646, 1646, 11077, 11077, 1212, 1212,
    5860, 5860, 6429, 6429, 3195, 3195, 9094, 9094,
    8785, 8785, 3504, 3504, 3542, 3542, 8747, 8747,
    2545, 2545, 9744, 9744, 3621, 3621, 8668, 8668,
    5728, 5728, 6561, 6561, 4591, 4591, 7698, 7698,
    5828, 5828, 6461, 6461, 5023, 5023, 7266, 7266,
    7311, 7311, 4978, 4978, 10938, 10938, 1351, 1351,
    3328, 3328, 8961, 8961, 6512, 6512, 5777, 5777,
    9664, 9664, 2625, 2625, 949, 949, 11340, 11340,
    4821, 4821, 7468, 7468, 2639, 2639, 9650, 9650,
    9314, 9314, 2975, 2975, 11726, 11726, 563, 563,
    3006, 3006, 9283, 9283, 9545, 9545, 2744, 2744,
    3091, 3091, 9198, 9198, 81, 81, 12208, 12208,
    11289, 11289, 1000, 1000, 7969, 7969, 4320, 4320,
    9238, 9238, 3051, 3051, 9923, 9923, 2366, 2366,
    2963, 2963, 9326, 9326, 7393, 7393, 4896, 4896,
    12149, 12149, 140, 140, 1853, 1853, 10436, 10436,
    11563, 11563, 726, 726, 7678, 7678, 4611, 4611,
    8034, 8034, 4255, 4255, 11112, 11112, 1177, 1177,
    1635, 1635, 10654, 10654, 9521, 9521, 2768, 2768,
    9088, 9088, 3201, 3201, 9275, 9275, 3014, 3014,
    10963, 10963, 1326, 1326, 5086, 5086, 7203, 7203,
    11119, 11119, 1170, 1170, 2319, 2319, 9970, 9970,
    955, 955, 11334, 11334, 11499, 11499, 790, 790,
    9154, 9154, 3135, 3135, 8577, 8577, 3712, 3712,
    7443, 7443, 4846, 4846, 9542, 9542, 2747, 2747,
    8736, 8736, 3553, 3553, 4805, 4805, 7484, 7484,
    1062, 1062, 11227, 11227, 9995, 9995, 2294, 2294,
    9447, 9447, 2842, 2842, 11809, 11809, 480, 480,
    9, 9, 12280, 12280, 1022, 1022, 11267, 11267,
    5791, 5791, 6498, 6498, 11745, 11745, 544, 544,
    2468, 2468, 9821, 9821, 339, 339, 11950, 11950,
    8112, 8112, 4177, 4177, 3584, 3584, 8705, 8705,
    9764, 9764, 2525, 2525, 1381, 1381, 10908, 10908,
    4278, 4278, 8011, 8011, 10616, 10616, 1673, 1673,
    5331, 5331, 6958, 6958, 7300, 7300, 4989, 4989,
    3949, 3949, 8340, 8340, 3296, 3296, 8993, 8993,
    2396, 2396, 9893, 9893, 4452, 4452, 7837, 7837,
    2837, 2837, 9452, 9452, 5374, 5374, 6915, 6915,
    4354, 4354, 7935, 7935, 130, 130, 12159, 12159,
    827, 827, 11462, 11462, 6522, 6522, 5767, 5767,
    953, 953, 11336, 11336, 8541, 8541, 3748, 3748,
    118, 118, 12171, 12171, 2476, 2476, 9813, 9813,
    10092, 10092, 2197, 2197, 7222, 7222, 5067, 5067,
    2013, 2013, 10276, 10276, 3289, 3289, 9000, 9000,
    3241, 3241, 9048, 9048, 729, 729, 11560, 11560,
    7197, 7197, 5092, 5092, 2089, 2089, 10200, 10200,
    9408, 9408, 2881, 2881, 3284, 3284, 9005, 9005,
    4632, 4632, 7657, 7657, 5755, 5755, 6534, 6534,
    11029, 11029, 1260, 1260, 4388, 4388, 7901, 7901,
    334, 334, 11955, 11955, 2426, 2426, 9863, 9863,
    10861, 10861, 1428, 1428, 1696, 1696, 10593, 10593,
    3382, 3382, 8907, 8907, 355, 355, 11934, 11934,
    8058, 8058, 4231, 4231, 9741, 9741, 2548, 2548,
    7110, 7110, 5179, 5179, 8595, 8595, 3694, 3694,
    1759, 1759, 10530, 10530, 8582, 8582, 3707, 3707,
    145, 145, 12144, 12144, 5542, 5542, 6747, 6747,
    8652, 8652, 3637, 3637, 3459, 3459, 8830, 8830,
    8357, 8357, 3932, 3932, 9558, 9558, 2731, 2731,
    4890, 4890, 7399, 7399, 6378, 6378, 5911, 5911,
};      // ω^i mod Q
const int16_t omega_inv[N] = {
    1, 1, 12288, 12288, 10810, 10810, 1479, 1479,
    5146, 5146, 7143, 7143, 8246, 8246, 4043, 4043,
    11567, 11567, 722, 722, 10984, 10984, 1305, 1305,
    8155, 8155, 4134, 4134, 6553, 6553, 5736, 5736,
    8668, 8668, 3621, 3621, 9744, 9744, 2545, 2545,
    8747, 8747, 3542, 3542, 3504, 3504, 8785, 8785,
    9094, 9094, 3195, 3195, 6429, 6429, 5860, 5860,
    1212, 1212, 11077, 11077, 1646, 1646, 10643, 10643,
    2744, 2744, 9545, 9545, 9283, 9283, 3006, 3006,
    563, 563, 11726, 11726, 2975, 2975, 9314, 9314,
    9650, 9650, 2639, 2639, 7468, 7468, 4821, 4821,
    11340, 11340, 949, 949, 2625, 2625, 9664, 9664,
    5777, 5777, 6512, 6512, 8961, 8961, 3328, 3328,
    1351, 1351, 10938, 10938, 4978, 4978, 7311, 7311,
    7266, 7266, 5023, 5023, 6461, 6461, 5828, 5828,
    7698, 7698, 4591, 4591, 6561, 6561, 5728, 5728,
    2294, 2294, 9995, 9995, 11227, 11227, 1062, 1062,
    7484, 7484, 4805, 4805, 3553, 3553, 8736, 8736,
    2747, 2747, 9542, 9542, 4846, 4846, 7443, 7443,
    3712, 3712, 8577, 8577, 3135, 3135, 9154, 9154,
    790, 790, 11499, 11499, 11334, 11334, 955, 955,
    9970, 9970, 2319, 2319, 1170, 1170, 11119, 11119,
    7203, 7203, 5086, 5086, 1326, 1326, 10963, 10963,
    3014, 3014, 9275, 9275, 3201, 3201, 9088, 9088,
    2768, 2768, 9521, 9521, 10654, 10654, 1635, 1635,
    1177, 1177, 11112, 11112, 4255, 4255, 8034, 8034,
    4611, 4611, 7678, 7678, 726, 726, 11563, 11563,
    10436, 10436, 1853, 1853, 140, 140, 12149, 12149,
    4896, 4896, 7393, 7393, 9326, 9326, 2963, 2963,
    2366, 2366, 9923, 9923, 3051, 3051, 9238, 9238,
    4320, 4320, 7969, 7969, 1000, 1000, 11289, 11289,
    12208, 12208, 81, 81, 9198, 9198, 3091, 3091,
    5911, 5911, 6378, 6378, 7399, 7399, 4890, 4890,
    2731, 2731, 9558, 9558, 3932, 3932, 8357, 8357,
    8830, 8830, 3459, 3459, 3637, 3637, 8652, 8652,
    6747, 6747, 5542, 5542, 12144, 12144, 145, 145,
    3707, 3707, 8582, 8582, 10530, 10530, 1759, 1759,
    3694, 3694, 8595, 8595, 5179, 5179, 7110, 7110,
    2548, 2548, 9741, 9741, 4231, 4231, 8058, 8058,
    11934, 11934, 355, 355, 8907, 8907, 3382, 3382,
    10593, 10593, 1696, 1696, 1428, 1428, 10861, 10861,
    9863, 9863, 2426, 2426, 11955, 11955, 334, 334,
    7901, 7901, 4388, 4388, 1260, 1260, 11029, 11029,
    6534, 6534, 5755, 5755, 7657, 7657, 4632, 4632,
    9005, 9005, 3284, 3284, 2881, 2881, 9408, 9408,
    10200, 10200, 2089, 2089, 5092, 5092, 7197, 7197,
    11560, 11560, 729, 729, 9048, 9048, 3241, 3241,
    9000, 9000, 3289, 3289, 10276, 10276, 2013, 2013,
    5067, 5067, 7222, 7222, 2197, 2197, 10092, 10092,
    9813, 9813, 2476, 2476, 12171, 12171, 118, 118,
    3748, 3748, 8541, 8541, 11336, 11336, 953, 953,
    5767, 5767, 6522, 6522, 11462, 11462, 827, 827,
    12159, 12159, 130, 130, 7935, 7935, 4354, 4354,
    6915, 6915, 5374, 5374, 9452, 9452, 2837, 2837,
    7837, 7837, 4452, 4452, 9893, 9893, 2396, 2396,
    8993, 8993, 3296, 3296, 8340, 8340, 3949, 3949,
    4989, 4989, 7300, 7300, 6958, 6958, 5331, 5331,
    1673, 1673, 10616, 10616, 8011, 8011, 4278, 4278,
    10908, 10908, 1381, 1381, 2525, 2525, 9764, 9764,
    8705, 8705, 3584, 3584, 4177, 4177, 8112, 8112,
    11950, 11950, 339, 339, 9821, 9821, 2468, 2468,
    544, 544, 11745, 11745, 6498, 6498, 5791, 5791,
    11267, 11267, 1022, 1022, 12280, 12280, 9, 9,
    480, 480, 11809, 11809, 2842, 2842, 9447, 9447,
};     // ω^{-i} mod Q

// Compute modular inverse using Extended Euclidean Algorithm
int16_t modinv(int16_t a, int16_t q) {
    int16_t t = 0, newt = 1;
    int16_t r = q, newr = a;
    while (newr != 0) {
        int16_t quotient = r / newr;
        int16_t temp = t;
        t = newt;
        newt = temp - quotient * newt;
        temp = r;
        r = newr;
        newr = temp - quotient * newr;
    }
    return t < 0 ? t + q : t;
}

// Forward NTT
void ntt(int16_t a[N]) {
    for (int len = 1; len < N; len <<= 1) {
        for (int i = 0; i < N; i += 2 * len) {
            for (int j = 0; j < len; j++) {
                int16_t u = a[i + j];
                int16_t v = (omega[N / (2 * len) * j] * a[i + j + len]) % Q;
                a[i + j] = (u + v) % Q;
                a[i + j + len] = (u - v + Q) % Q;
            }
        }
    }
}

// Inverse NTT
void intt(int16_t a[N]) {
    for (int len = N / 2; len >= 1; len >>= 1) {
        for (int i = 0; i < N; i += 2 * len) {
            for (int j = 0; j < len; j++) {
                int16_t u = a[i + j];
                int16_t v = a[i + j + len];
                a[i + j] = (u + v) % Q;
                a[i + j + len] = ((u - v + Q) * omega_inv[N / (2 * len) * j]) % Q;
            }
        }
    }

    // Normalize (divide by N)
    int16_t inv_n = modinv(N, Q);
    for (int i = 0; i < N; i++) {
        a[i] = (a[i] * inv_n) % Q;
    }
}

// Pointwise multiplication
void pointwise_mul(int16_t r[N], const int16_t a[N], const int16_t b[N]) {
    for (int i = 0; i < N; i++) {
        r[i] = (a[i] * b[i]) % Q;
    }
}

// Wrapper for Polynomial type multiplication using NTT
Polynomial ntt_multiply(Polynomial a, Polynomial b) {
    int16_t A[N] = {0}, B[N] = {0}, R[N] = {0};
    Polynomial result;

    // Copy coefficients into arrays
    for (int i = 0; i < a.degree && i < N; i++) A[i] = a.coeffs[i];
    for (int i = 0; i < b.degree && i < N; i++) B[i] = b.coeffs[i];

    ntt(A);
    ntt(B);
    pointwise_mul(R, A, B);
    intt(R);

    // Fill result polynomial
    result.degree = N;
    for (int i = 0; i < N; i++) {
        result.coeffs[i] = R[i];
    }

    return result;
}